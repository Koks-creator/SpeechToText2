{% extends 'layout.html' %}

{% block content %}
<h1 class="mb-3">Speech to Text</h1>

<div class="card">
    <form id="uploadForm" method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.images_field.label }}
            <div class="file-upload">
                <div class="file-upload-area" id="dropZone">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <p>Drag & drop audio files here</p>
                    <span>or click to browse</span>
                </div>
                {{ form.images_field(class="file-input", id="fileInput") }}
            </div>
            <div class="file-list" id="fileList"></div>
            {% if form.images_field.errors %}
                {% for error in form.images_field.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            {% endif %}
        </div>

        <div class="form-group">
            <label class="toggle-label">
                {{ form.normalize_list_field(class="toggle-input") }}
                <span class="toggle-switch"></span>
                <span class="toggle-text">Normalize audio</span>
                <span class="tooltip-icon" tabindex="0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span class="tooltip-text">Enable to normalize provided audio files to 16000MHz sample rate.</span>
                </span>
            </label>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">
            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            <span class="btn-text">Get Transcription</span>
            <span class="spinner"></span>
        </button>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Processing audio files...</p>
        <span>This may take a moment</span>
    </div>
</div>

{% if results %}
<div class="results">
    <h2>Results</h2>
    
    {% for item in results %}
    <div class="result-item">
        <div class="result-header">
            <span class="result-number">{{ loop.index }}</span>
            <span class="result-filename">{{ item.filename }}</span>
        </div>
        
        <div class="audio-player">
            <audio id="audio-{{ loop.index }}">
                <source src="{{ url_for('serve_audio', filename=item.filename) }}" type="audio/wav">
            </audio>
            
            <button class="player-btn play-btn" data-audio="audio-{{ loop.index }}">
                <svg class="icon-play" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                <svg class="icon-pause" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            </button>
            
            <div class="player-progress">
                <div class="progress-bar" data-audio="audio-{{ loop.index }}">
                    <div class="progress-fill"></div>
                </div>
            </div>
            
            <span class="player-time" data-audio="audio-{{ loop.index }}">0:00 / 0:00</span>
            
            <div class="volume-control">
                <button class="volume-btn" data-audio="audio-{{ loop.index }}">
                    <svg class="icon-volume-high" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                    </svg>
                    <svg class="icon-volume-low" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                    <svg class="icon-volume-mute" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <line x1="23" y1="9" x2="17" y2="15"/>
                        <line x1="17" y1="9" x2="23" y2="15"/>
                    </svg>
                </button>
                <div class="volume-slider-wrapper">
                    <input type="range" class="volume-slider" data-audio="audio-{{ loop.index }}" min="0" max="1" step="0.05" value="1">
                </div>
            </div>
        </div>
        
        <div class="transcription-box">
            <p class="transcription-text" id="text-{{ loop.index }}">{{ item.transcription }}</p>
            <button class="btn-copy" data-target="text-{{ loop.index }}" title="Copy to clipboard">
                <svg class="icon-copy" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
                <svg class="icon-check" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
